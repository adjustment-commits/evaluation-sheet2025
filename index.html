<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>ã‚»ãƒŸãƒ‘ãƒ¼ã‚½ãƒŠãƒ« ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { font-family: system-ui, sans-serif; background:#f8f8f8; margin:20px; }
    h1 { text-align:center; }
    .form-section { background:#fff; padding:15px; border-radius:8px; margin-bottom:20px; }
    label { display:inline-block; width:160px; margin:5px 0; }
    .charts { display:flex; flex-wrap:wrap; gap:20px; justify-content:space-around; }
    .chart-box { flex:1 1 300px; max-width:400px; background:#fff; padding:15px; border-radius:8px; }
    .eval-box { display:inline-block; padding:6px 12px; border-radius:6px; font-weight:bold; color:#fff; margin:3px 0; }
    .eval-ç·‘ { background:#2ecc71; }
    .eval-é»„ { background:#f1c40f; color:#000; }
    .eval-èµ¤ { background:#e74c3c; }
    .diff-item { background:#fff; padding:6px; border-radius:6px; font-size:14px; box-shadow:0 1px 3px rgba(0,0,0,0.1); }
    .diff-bar { height:6px; border-radius:3px; margin-top:4px; }
    .up-bar { background:#2ecc71; }
    .down-bar { background:#e74c3c; }
    .same-bar { background:#bdc3c7; }
    .info-box { background:#f9f9f9; border-left:4px solid #3498db; padding:8px; margin:6px 0; font-size:14px; border-radius:4px; }
    .info-btn { margin-left:6px; cursor:pointer; }
  </style>
</head>
<body>
  <h1>ã‚»ãƒŸãƒ‘ãƒ¼ã‚½ãƒŠãƒ« ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</h1>

  <!-- é¸æ‰‹ã¨æ—¥ä»˜ -->
  <div class="form-section">
    <label>é¸æ‰‹:</label>
    <select id="playerSelect" onchange="switchPlayer()">
      <option value="A">é¸æ‰‹A</option>
      <option value="B">é¸æ‰‹B</option>
      <option value="C">é¸æ‰‹C</option>
    </select>

    <label>åŸºæº–æ—¥ä»˜:</label>
    <select id="dateSelect" onchange="loadSelectedDate()">
      <option value="">-- æ—¥ä»˜ã‚’é¸æŠ --</option>
    </select>

    <label>æ¯”è¼ƒæ—¥ä»˜:</label>
    <select id="compareSelect" onchange="updateCharts()">
      <option value="">-- æ¯”è¼ƒãªã— --</option>
    </select>
    <br>

    <button onclick="saveData()">ä¿å­˜</button>
    <button onclick="updateCharts()">æ›´æ–°</button>
  </div>

  <!-- å…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ  + â„¹ï¸èª¬æ˜ -->
  <div class="form-section">
    <label>æ—¥ä»˜å…¥åŠ›:</label><input type="date" id="testDate"><br>

    <label>CMJ é€šå¸¸ (cm):</label>
    <input type="number" id="cmjNormal">
    <button type="button" class="info-btn" onclick="toggleInfo('cmjInfo')">â„¹ï¸</button>
    <div id="cmjInfo" class="info-box" style="display:none;">
      <b>CMJï¼ˆã‚«ã‚¦ãƒ³ã‚¿ãƒ¼ãƒ ãƒ¼ãƒ–ãƒ¡ãƒ³ãƒˆã‚¸ãƒ£ãƒ³ãƒ—ï¼‰</b><br>
      æ–¹æ³•: ä¸¡æ‰‹ã‚’è…°ã«å½“ã¦åå‹•ã‚¸ãƒ£ãƒ³ãƒ—<br>
      åŸºæº–: 60cmä»¥ä¸Šï¼å„ªç§€ / 50cmä»¥ä¸Šï¼æ¨™æº– / 50cmæœªæº€ï¼æ”¹å–„å¿…è¦
    </div><br>

    <label>CMJ ç–²åŠ´ä¸‹ (cm):</label><input type="number" id="cmjFatigue"><br>

    <label>RSI é€šå¸¸:</label>
    <input type="number" step="0.01" id="rjNormal">
    <button type="button" class="info-btn" onclick="toggleInfo('rjInfo')">â„¹ï¸</button>
    <div id="rjInfo" class="info-box" style="display:none;">
      <b>ãƒªãƒã‚¦ãƒ³ãƒ‰ã‚¸ãƒ£ãƒ³ãƒ—ï¼ˆRSIï¼‰</b><br>
      æ–¹æ³•: 10å›é€£ç¶šã‚¸ãƒ£ãƒ³ãƒ—ã€‚é«˜ã•Ã·æ¥åœ°æ™‚é–“<br>
      åŸºæº–: 2.5ä»¥ä¸Šï¼é«˜æ°´æº– / 2.0ä»¥ä¸Šï¼æ¨™æº– / 2.0æœªæº€ï¼æ”¹å–„å¿…è¦
    </div><br>

    <label>RSI ç–²åŠ´ä¸‹:</label><input type="number" step="0.01" id="rjFatigue"><br>

    <label>MBã‚¹ãƒ©ãƒ  é€šå¸¸ é€Ÿåº¦:</label>
    <input type="number" step="0.1" id="slamNormal">
    <button type="button" class="info-btn" onclick="toggleInfo('slamInfo')">â„¹ï¸</button>
    <div id="slamInfo" class="info-box" style="display:none;">
      <b>ãƒ¡ãƒ‡ã‚£ã‚·ãƒ³ãƒœãƒ¼ãƒ«ã‚¹ãƒ©ãƒ </b><br>
      æ–¹æ³•: é ­ä¸Šã‹ã‚‰åºŠã¸å…¨åŠ›ã§å©ãã¤ã‘ã‚‹ã€‚é€Ÿåº¦ã‚»ãƒ³ã‚µãƒ¼ã§è¨ˆæ¸¬ã€‚<br>
      åŸºæº–: 4.0m/sä»¥ä¸Šï¼å„ªç§€ / 3.0m/sä»¥ä¸Šï¼æ¨™æº– / 3.0æœªæº€ï¼æ”¹å–„å¿…è¦
    </div><br>

    <label>MBã‚¹ãƒ©ãƒ  é€šå¸¸ å¤‰å‹•ç‡ (%):</label><input type="number" id="slamVarNormal"><br>
    <label>MBã‚¹ãƒ©ãƒ  ç–²åŠ´ä¸‹ é€Ÿåº¦:</label><input type="number" step="0.1" id="slamFatigue"><br>
    <label>MBã‚¹ãƒ©ãƒ  ç–²åŠ´ä¸‹ å¤‰å‹•ç‡ (%):</label><input type="number" id="slamVarFatigue"><br>

    <label>éª¨ç›¤ãƒ¬ãƒƒã‚° é€šå¸¸ (0-5):</label>
    <input type="number" id="pelvisNormal">
    <button type="button" class="info-btn" onclick="toggleInfo('pelvisInfo')">â„¹ï¸</button>
    <div id="pelvisInfo" class="info-box" style="display:none;">
      <b>éª¨ç›¤ãƒ¬ãƒƒã‚°</b><br>
      æ–¹æ³•: éª¨ç›¤ã§è„šã‚’å¼•ãä¸Šã’ã€è„šã«åŠ›ã‚’æŠœãã€‚<br>
      åŸºæº–: 4â€“5ï¼å®‰å®š / 2â€“3ï¼ä¸å®‰å®š / 1ï¼èª²é¡Œå¤§
    </div><br>

    <label>éª¨ç›¤ãƒ¬ãƒƒã‚° ç–²åŠ´ä¸‹ (0-5):</label><input type="number" id="pelvisFatigue"><br>

    <label>èƒ¸éƒ­ãƒ—ãƒƒã‚·ãƒ¥ é€šå¸¸ (0-5):</label>
    <input type="number" id="thoraxNormal">
    <button type="button" class="info-btn" onclick="toggleInfo('thoraxInfo')">â„¹ï¸</button>
    <div id="thoraxInfo" class="info-box" style="display:none;">
      <b>èƒ¸éƒ­ãƒ—ãƒƒã‚·ãƒ¥</b><br>
      æ–¹æ³•: æ”¯æŒè…•ã‚’å›ºå®šã—èƒ¸éƒ­ã‹ã‚‰å›æ—‹ã€‚è…•ã ã‘ã®å‹•ãã¯Ã—ã€‚<br>
      åŸºæº–: 4â€“5ï¼è‰¯å¥½ / 2â€“3ï¼æ”¹å–„å¿…è¦ / 1ï¼èª²é¡Œå¤§
    </div><br>

    <label>èƒ¸éƒ­ãƒ—ãƒƒã‚·ãƒ¥ ç–²åŠ´ä¸‹ (0-5):</label><input type="number" id="thoraxFatigue"><br>
  </div>

  <!-- ç·è©• -->
  <div class="form-section">
    <h2>ç·è©•</h2>
    <div id="summaryBox"></div>
    <h3>æ¬¡ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³</h3>
    <div id="actionBox"></div>
  </div>

  <!-- å·®åˆ†ã‚µãƒãƒªãƒ¼ -->
  <div class="form-section">
    <h2>å·®åˆ†ã‚µãƒãƒªãƒ¼</h2>
    <div id="diffBox" style="display:grid;grid-template-columns:1fr 1fr;gap:8px;"></div>
  </div>

  <!-- ã‚°ãƒ©ãƒ• -->
  <div class="charts">
    <div class="chart-box"><canvas id="cmjChart"></canvas></div>
    <div class="chart-box"><canvas id="rjChart"></canvas></div>
    <div class="chart-box"><canvas id="slamChart"></canvas></div>
    <div class="chart-box"><canvas id="opChart"></canvas></div>
  </div>

  <!-- å±¥æ­´ãƒãƒ£ãƒ¼ãƒˆ -->
  <div class="form-section">
    <h2>å±¥æ­´ãƒãƒ£ãƒ¼ãƒˆï¼ˆå€‹äººï¼‰</h2>
    <canvas id="historyChart"></canvas>
  </div>

  <script>
    function toggleInfo(id) {
      const el = document.getElementById(id);
      el.style.display = (el.style.display==="none" ? "block" : "none");
    }

    let cmjChart, rjChart, slamChart, opChart, historyChart;
    let currentPlayer = "A";

    function getRecord(player, date) {
      let db = JSON.parse(localStorage.getItem("records") || "{}");
      const recs = db[player] || [];
      return recs.find(r => r.date === date);
    }

    function switchPlayer() {
      currentPlayer = document.getElementById("playerSelect").value;
      populateDateOptions(currentPlayer);
      drawHistoryChart(currentPlayer);
    }

    function saveData() {
      const record = {
        date: testDate.value,
        cmj: [cmjNormal.value, cmjFatigue.value],
        rj: [rjNormal.value, rjFatigue.value],
        slam: [slamNormal.value, slamFatigue.value],
        slamVar: [slamVarNormal.value, slamVarFatigue.value],
        pelvis: [pelvisNormal.value, pelvisFatigue.value],
        thorax: [thoraxNormal.value, thoraxFatigue.value]
      };
      let db = JSON.parse(localStorage.getItem("records") || "{}");
      if (!db[currentPlayer]) db[currentPlayer] = [];
      db[currentPlayer].push(record);
      localStorage.setItem("records", JSON.stringify(db));
      populateDateOptions(currentPlayer);
      alert("ä¿å­˜ã—ã¾ã—ãŸ: " + currentPlayer);
    }

    function populateDateOptions(player) {
      let db = JSON.parse(localStorage.getItem("records") || "{}");
      const recs = db[player] || [];
      const dateSelect = document.getElementById("dateSelect");
      const compareSelect = document.getElementById("compareSelect");
      dateSelect.innerHTML = '<option value="">-- æ—¥ä»˜ã‚’é¸æŠ --</option>';
      compareSelect.innerHTML = '<option value="">-- æ¯”è¼ƒãªã— --</option>';
      recs.forEach(r => {
        let opt1 = document.createElement("option");
        opt1.value = r.date; opt1.text = r.date; dateSelect.appendChild(opt1);
        let opt2 = document.createElement("option");
        opt2.value = r.date; opt2.text = r.date; compareSelect.appendChild(opt2);
      });
    }

    function loadSelectedDate() {
      const date = document.getElementById("dateSelect").value;
      if (!date) return;
      const rec = getRecord(currentPlayer, date);
      if (rec) {
        testDate.value = rec.date;
        cmjNormal.value = rec.cmj[0];
        cmjFatigue.value = rec.cmj[1];
        rjNormal.value = rec.rj[0];
        rjFatigue.value = rec.rj[1];
        slamNormal.value = rec.slam[0];
        slamFatigue.value = rec.slam[1];
        slamVarNormal.value = rec.slamVar[0];
        slamVarFatigue.value = rec.slamVar[1];
        pelvisNormal.value = rec.pelvis[0];
        pelvisFatigue.value = rec.pelvis[1];
        thoraxNormal.value = rec.thorax[0];
        thoraxFatigue.value = rec.thorax[1];
        updateCharts();
      }
    }

    function arrowSymbol(val, inverse=false) {
      if (val > 0) return inverse ? "ğŸ”´â†“" : "ğŸŸ¢â†‘";
      if (val < 0) return inverse ? "ğŸŸ¢â†‘" : "ğŸ”´â†“";
      return "âšªï¸â†’";
    }

    function diffBarHTML(val, inverse=false) {
      const absVal = Math.min(Math.abs(val),10);
      const width = absVal * 10;
      if (val > 0) return `<div class="diff-bar ${inverse?"down-bar":"up-bar"}" style="width:${width}%;"></div>`;
      if (val < 0) return `<div class="diff-bar ${inverse?"up-bar":"down-bar"}" style="width:${width}%;"></div>`;
      return `<div class="diff-bar same-bar" style="width:10%;"></div>`;
    }

    function createChart(ctx, label, data, unit, tooltipExtra=null, maxY=null) {
      return new Chart(ctx, {
        type: 'bar',
        data: { labels:['é€šå¸¸','ç–²åŠ´ä¸‹'], datasets:[{label:label,data:data,backgroundColor:['#3498db','#9b59b6']}] },
        options: { responsive:true,
          plugins:{ legend:{display:false}, title:{display:true,text:label},
            tooltip:{ callbacks:{ afterBody:function(c){ if(tooltipExtra){return tooltipExtra[c[0].dataIndex];}}}}},
          scales:{ y:{ beginAtZero:true, max:maxY, title:{display:true,text:unit}}}
        }
      });
    }

    function updateCharts() {
      const baseDate = document.getElementById("dateSelect").value;
      const compareDate = document.getElementById("compareSelect").value;
      const baseRec = getRecord(currentPlayer, baseDate);
      const compareRec = compareDate ? getRecord(currentPlayer, compareDate) : null;
      if (!baseRec) return;

      const cmjVals=[parseFloat(baseRec.cmj[0])||0, parseFloat(baseRec.cmj[1])||0];
      const rjVals=[parseFloat(baseRec.rj[0])||0, parseFloat(baseRec.rj[1])||0];
      const slamVals=[parseFloat(baseRec.slam[0])||0, parseFloat(baseRec.slam[1])||0];
      const slamVar=[parseFloat(baseRec.slamVar[0])||0, parseFloat(baseRec.slamVar[1])||0];
      const opTotal=[(parseFloat(baseRec.pelvis[0])||0)+(parseFloat(baseRec.thorax[0])||0),
                     (parseFloat(baseRec.pelvis[1])||0)+(parseFloat(baseRec.thorax[1])||0)];

      if(cmjChart) cmjChart.destroy();
      if(rjChart) rjChart.destroy();
      if(slamChart) slamChart.destroy();
      if(opChart) opChart.destroy();

      cmjChart=createChart(document.getElementById('cmjChart'),'CMJ (cm)',cmjVals,'cm');
      rjChart=createChart(document.getElementById('rjChart'),'ãƒªãƒã‚¦ãƒ³ãƒ‰ã‚¸ãƒ£ãƒ³ãƒ— RSI',rjVals,'RSI');
      slamChart=createChart(document.getElementById('slamChart'),'MBã‚¹ãƒ©ãƒ  å¹³å‡é€Ÿåº¦ (m/s)',slamVals,'m/s',[`å¤‰å‹•ç‡:${slamVar[0]}%`,`å¤‰å‹•ç‡:${slamVar[1]}%`]);
      opChart=createChart(document.getElementById('opChart'),'æ“ä½œåŠ›ï¼ˆ10ç‚¹æº€ç‚¹ï¼‰',opTotal,'å¾—ç‚¹',[`éª¨ç›¤:${baseRec.pelvis[0]} èƒ¸éƒ­:${baseRec.thorax[0]}`,`éª¨ç›¤:${baseRec.pelvis[1]} èƒ¸éƒ­:${baseRec.thorax[1]}`],10);

      // ç·è©•
      const cmjRate=(cmjVals[1]/(cmjVals[0]||1))*100;
      const slamRate=(slamVals[1]/(slamVals[0]||1))*100;
      const rate=Math.min(cmjRate,slamRate);
      const output=(cmjVals[0]>=60&&rjVals[0]>=2.5&&slamVals[0]>=4.0&&slamVar[0]<=10)?"ç·‘":(cmjVals[0]>=50&&rjVals[0]>=2.0&&slamVals[0]>=3.0&&slamVar[0]<=20)?"é»„":"èµ¤";
      const operation=(opTotal[0]>=9)?"ç·‘":(opTotal[0]>=6)?"é»„":"èµ¤";
      const repeat=(rate>=80&&slamVar[1]<=20)?"ç·‘":(rate>=60&&slamVar[1]<=30)?"é»„":"èµ¤";

      document.getElementById("summaryBox").innerHTML=`
        <div class="eval-box eval-${output}">å‡ºåŠ›é‡: ${output}</div>
        <div class="eval-box eval-${operation}">æ“ä½œåŠ›: ${operation}</div>
        <div class="eval-box eval-${repeat}">å†ç¾æ€§: ${repeat}</div>
      `;
      let actions="";
      actions += "<b>å‡ºåŠ›é‡:</b> "+(output==="ç·‘"?"å‡ºåŠ›ã¯ååˆ†ã€‚ç¶­æŒã‚’å„ªå…ˆã€‚":output==="é»„"?"å‡ºåŠ›ã¯ã‚ã‚‹ãŒå‡ºã—åˆ‡ã‚Œã¦ã„ãªã„ã€‚ãƒ‘ãƒ¯ãƒ¼ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°å¼·åŒ–ã€‚":"å‡ºåŠ›ä¸è¶³ã€‚ã‚¦ã‚¨ã‚¤ãƒˆãƒ»ã‚¸ãƒ£ãƒ³ãƒ—ç³»ã‚’é‡ç‚¹çš„ã«ã€‚")+"<br>";
      actions += "<b>æ“ä½œåŠ›:</b> "+(operation==="ç·‘"?"éª¨ç›¤ã¨èƒ¸éƒ­ã®é€£å‹•è‰¯å¥½ã€‚ç¶™ç¶šã€‚":operation==="é»„"?"é€£å‹•ã¯ä¸å®‰å®šã€‚éª¨ç›¤-èƒ¸éƒ­é€£å‹•ãƒ‰ãƒªãƒ«ã‚’è¿½åŠ ã€‚":"ä½“å¹¹ä¸»å°ãŒå¼±ã„ã€‚åŸºç¤ã‹ã‚‰å†æ§‹ç¯‰ãŒå¿…è¦ã€‚")+"<br>";
      actions += "<b>å†ç¾æ€§:</b> "+(repeat==="ç·‘"?"å®‰å®šã—ã¦ã„ã‚‹ã€‚é«˜å¼·åº¦ä¸‹ã§ã®å®Ÿè·µã¸ã€‚":repeat==="é»„"?"ã‚„ã‚„ä¹±ã‚Œã‚‹ã€‚æŒä¹…æ€§ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ã‚’å¼·åŒ–ã€‚":"ç–²åŠ´ä¸‹ã§å¤§ããä½ä¸‹ã€‚å¿ƒè‚ºãƒ»åŸºç¤åå¾©ã‚’å„ªå…ˆã€‚");

      document.getElementById("actionBox").innerHTML = actions;

      // å·®åˆ†ã‚µãƒãƒªãƒ¼
      if (compareRec) {
        const cmjDiff = (cmjVals[0] - (parseFloat(compareRec.cmj[0])||0)).toFixed(1);
        const rjDiff = (rjVals[0] - (parseFloat(compareRec.rj[0])||0)).toFixed(2);
        const slamDiff = (slamVals[0] - (parseFloat(compareRec.slam[0])||0)).toFixed(2);
        const varDiff = (slamVar[0] - (parseFloat(compareRec.slamVar[0])||0)).toFixed(1);
        const opDiff = (opTotal[0] - ((parseFloat(compareRec.pelvis[0])||0)+(parseFloat(compareRec.thorax[0])||0))).toFixed(0);

        document.getElementById("diffBox").innerHTML = `
          <div class="diff-item">CMJ: ${cmjDiff>=0?"+":""}${cmjDiff}cm ${arrowSymbol(cmjDiff)} ${diffBarHTML(cmjDiff)}</div>
          <div class="diff-item">RSI: ${rjDiff>=0?"+":""}${rjDiff} ${arrowSymbol(rjDiff)} ${diffBarHTML(rjDiff)}</div>
          <div class="diff-item">MBã‚¹ãƒ©ãƒ : ${slamDiff>=0?"+":""}${slamDiff}m/s ${arrowSymbol(slamDiff)} ${diffBarHTML(slamDiff)}</div>
          <div class="diff-item">å¤‰å‹•ç‡: ${varDiff>=0?"+":""}${varDiff}% ${arrowSymbol(varDiff,true)} ${diffBarHTML(-varDiff)}</div>
          <div class="diff-item">æ“ä½œåŠ›: ${opDiff>=0?"+":""}${opDiff}ç‚¹ ${arrowSymbol(opDiff)} ${diffBarHTML(opDiff)}</div>
        `;
      }

      // å±¥æ­´ãƒãƒ£ãƒ¼ãƒˆæ›´æ–°
      drawHistoryChart(currentPlayer);
    }

    function drawHistoryChart(player) {
      let db = JSON.parse(localStorage.getItem("records") || "{}");
      const recs = (db[player] || []).sort((a,b)=> new Date(a.date) - new Date(b.date));
      if (recs.length===0){ if(historyChart) historyChart.destroy(); return; }

      const dates = recs.map(r => r.date);
      const cmj = recs.map(r => parseFloat(r.cmj[0])||0);
      const rj = recs.map(r => parseFloat(r.rj[0])||0);
      const slam = recs.map(r => parseFloat(r.slam[0])||0);
      const op   = recs.map(r => (parseFloat(r.pelvis[0])||0)+(parseFloat(r.thorax[0])||0));

      if(historyChart) historyChart.destroy();
      historyChart = new Chart(document.getElementById("historyChart"), {
        type: 'line',
        data: {
          labels: dates,
          datasets: [
            { label:"CMJ", data: cmj, borderColor:"#3498db", fill:false },
            { label:"RSI", data: rj, borderColor:"#2ecc71", fill:false },
            { label:"MBã‚¹ãƒ©ãƒ ", data: slam, borderColor:"#e67e22", fill:false },
            { label:"æ“ä½œåŠ›", data: op, borderColor:"#9b59b6", fill:false }
          ]
        },
        options: { responsive:true, plugins:{ title:{ display:true, text:"å±¥æ­´æ¨ç§»" } } }
      });
    }
  </script>
</body>
</html>
