<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>セミパーソナル ダッシュボード</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { font-family: system-ui, sans-serif; background:#f8f8f8; margin:20px; }
    h1 { text-align:center; }
    .form-section { background:#fff; padding:15px; border-radius:8px; margin-bottom:20px; }
    label { display:inline-block; width:160px; margin:5px 0; }
    .charts { display:flex; flex-wrap:wrap; gap:20px; justify-content:space-around; }
    .chart-box { flex:1 1 300px; max-width:400px; background:#fff; padding:15px; border-radius:8px; }
    .eval-box { display:inline-block; padding:6px 12px; border-radius:6px; font-weight:bold; color:#fff; margin:3px 0; }
    .eval-緑 { background:#2ecc71; }
    .eval-黄 { background:#f1c40f; color:#000; }
    .eval-赤 { background:#e74c3c; }
    .diff-item { background:#fff; padding:6px; border-radius:6px; font-size:14px; box-shadow:0 1px 3px rgba(0,0,0,0.1); }
    .diff-bar { height:6px; border-radius:3px; margin-top:4px; }
    .up-bar { background:#2ecc71; }
    .down-bar { background:#e74c3c; }
    .same-bar { background:#bdc3c7; }
    .info-box { background:#f9f9f9; border-left:4px solid #3498db; padding:8px; margin:6px 0; font-size:14px; border-radius:4px; }
    .info-btn { margin-left:6px; cursor:pointer; }
  </style>
</head>
<body>
  <h1>セミパーソナル ダッシュボード</h1>

  <!-- 選手と日付 -->
  <div class="form-section">
    <label>選手:</label>
    <select id="playerSelect" onchange="switchPlayer()">
      <option value="A">選手A</option>
      <option value="B">選手B</option>
      <option value="C">選手C</option>
    </select>

    <label>基準日付:</label>
    <select id="dateSelect" onchange="loadSelectedDate()">
      <option value="">-- 日付を選択 --</option>
    </select>

    <label>比較日付:</label>
    <select id="compareSelect" onchange="updateCharts()">
      <option value="">-- 比較なし --</option>
    </select>
    <br>

    <button onclick="saveData()">保存</button>
    <button onclick="updateCharts()">更新</button>
  </div>

  <!-- 入力フォーム + ℹ️説明 -->
  <div class="form-section">
    <label>日付入力:</label><input type="date" id="testDate"><br>

    <label>CMJ 通常 (cm):</label>
    <input type="number" id="cmjNormal">
    <button type="button" class="info-btn" onclick="toggleInfo('cmjInfo')">ℹ️</button>
    <div id="cmjInfo" class="info-box" style="display:none;">
      <b>CMJ（カウンタームーブメントジャンプ）</b><br>
      方法: 両手を腰に当て反動ジャンプ<br>
      基準: 60cm以上＝優秀 / 50cm以上＝標準 / 50cm未満＝改善必要
    </div><br>

    <label>CMJ 疲労下 (cm):</label><input type="number" id="cmjFatigue"><br>

    <label>RSI 通常:</label>
    <input type="number" step="0.01" id="rjNormal">
    <button type="button" class="info-btn" onclick="toggleInfo('rjInfo')">ℹ️</button>
    <div id="rjInfo" class="info-box" style="display:none;">
      <b>リバウンドジャンプ（RSI）</b><br>
      方法: 10回連続ジャンプ。高さ÷接地時間<br>
      基準: 2.5以上＝高水準 / 2.0以上＝標準 / 2.0未満＝改善必要
    </div><br>

    <label>RSI 疲労下:</label><input type="number" step="0.01" id="rjFatigue"><br>

    <label>MBスラム 通常 速度:</label>
    <input type="number" step="0.1" id="slamNormal">
    <button type="button" class="info-btn" onclick="toggleInfo('slamInfo')">ℹ️</button>
    <div id="slamInfo" class="info-box" style="display:none;">
      <b>メディシンボールスラム</b><br>
      方法: 頭上から床へ全力で叩きつける。速度センサーで計測。<br>
      基準: 4.0m/s以上＝優秀 / 3.0m/s以上＝標準 / 3.0未満＝改善必要
    </div><br>

    <label>MBスラム 通常 変動率 (%):</label><input type="number" id="slamVarNormal"><br>
    <label>MBスラム 疲労下 速度:</label><input type="number" step="0.1" id="slamFatigue"><br>
    <label>MBスラム 疲労下 変動率 (%):</label><input type="number" id="slamVarFatigue"><br>

    <label>骨盤レッグ 通常 (0-5):</label>
    <input type="number" id="pelvisNormal">
    <button type="button" class="info-btn" onclick="toggleInfo('pelvisInfo')">ℹ️</button>
    <div id="pelvisInfo" class="info-box" style="display:none;">
      <b>骨盤レッグ</b><br>
      方法: 骨盤で脚を引き上げ、脚に力を抜く。<br>
      基準: 4–5＝安定 / 2–3＝不安定 / 1＝課題大
    </div><br>

    <label>骨盤レッグ 疲労下 (0-5):</label><input type="number" id="pelvisFatigue"><br>

    <label>胸郭プッシュ 通常 (0-5):</label>
    <input type="number" id="thoraxNormal">
    <button type="button" class="info-btn" onclick="toggleInfo('thoraxInfo')">ℹ️</button>
    <div id="thoraxInfo" class="info-box" style="display:none;">
      <b>胸郭プッシュ</b><br>
      方法: 支持腕を固定し胸郭から回旋。腕だけの動きは×。<br>
      基準: 4–5＝良好 / 2–3＝改善必要 / 1＝課題大
    </div><br>

    <label>胸郭プッシュ 疲労下 (0-5):</label><input type="number" id="thoraxFatigue"><br>
  </div>

  <!-- 総評 -->
  <div class="form-section">
    <h2>総評</h2>
    <div id="summaryBox"></div>
    <h3>次のアクション</h3>
    <div id="actionBox"></div>
  </div>

  <!-- 差分サマリー -->
  <div class="form-section">
    <h2>差分サマリー</h2>
    <div id="diffBox" style="display:grid;grid-template-columns:1fr 1fr;gap:8px;"></div>
  </div>

  <!-- グラフ -->
  <div class="charts">
    <div class="chart-box"><canvas id="cmjChart"></canvas></div>
    <div class="chart-box"><canvas id="rjChart"></canvas></div>
    <div class="chart-box"><canvas id="slamChart"></canvas></div>
    <div class="chart-box"><canvas id="opChart"></canvas></div>
  </div>

  <!-- 履歴チャート -->
  <div class="form-section">
    <h2>履歴チャート（個人）</h2>
    <canvas id="historyChart"></canvas>
  </div>

  <script>
    function toggleInfo(id) {
      const el = document.getElementById(id);
      el.style.display = (el.style.display==="none" ? "block" : "none");
    }

    let cmjChart, rjChart, slamChart, opChart, historyChart;
    let currentPlayer = "A";

    function getRecord(player, date) {
      let db = JSON.parse(localStorage.getItem("records") || "{}");
      const recs = db[player] || [];
      return recs.find(r => r.date === date);
    }

    function switchPlayer() {
      currentPlayer = document.getElementById("playerSelect").value;
      populateDateOptions(currentPlayer);
      drawHistoryChart(currentPlayer);
    }

    function saveData() {
      const record = {
        date: testDate.value,
        cmj: [cmjNormal.value, cmjFatigue.value],
        rj: [rjNormal.value, rjFatigue.value],
        slam: [slamNormal.value, slamFatigue.value],
        slamVar: [slamVarNormal.value, slamVarFatigue.value],
        pelvis: [pelvisNormal.value, pelvisFatigue.value],
        thorax: [thoraxNormal.value, thoraxFatigue.value]
      };
      let db = JSON.parse(localStorage.getItem("records") || "{}");
      if (!db[currentPlayer]) db[currentPlayer] = [];
      db[currentPlayer].push(record);
      localStorage.setItem("records", JSON.stringify(db));
      populateDateOptions(currentPlayer);
      alert("保存しました: " + currentPlayer);
    }

    function populateDateOptions(player) {
      let db = JSON.parse(localStorage.getItem("records") || "{}");
      const recs = db[player] || [];
      const dateSelect = document.getElementById("dateSelect");
      const compareSelect = document.getElementById("compareSelect");
      dateSelect.innerHTML = '<option value="">-- 日付を選択 --</option>';
      compareSelect.innerHTML = '<option value="">-- 比較なし --</option>';
      recs.forEach(r => {
        let opt1 = document.createElement("option");
        opt1.value = r.date; opt1.text = r.date; dateSelect.appendChild(opt1);
        let opt2 = document.createElement("option");
        opt2.value = r.date; opt2.text = r.date; compareSelect.appendChild(opt2);
      });
    }

    function loadSelectedDate() {
      const date = document.getElementById("dateSelect").value;
      if (!date) return;
      const rec = getRecord(currentPlayer, date);
      if (rec) {
        testDate.value = rec.date;
        cmjNormal.value = rec.cmj[0];
        cmjFatigue.value = rec.cmj[1];
        rjNormal.value = rec.rj[0];
        rjFatigue.value = rec.rj[1];
        slamNormal.value = rec.slam[0];
        slamFatigue.value = rec.slam[1];
        slamVarNormal.value = rec.slamVar[0];
        slamVarFatigue.value = rec.slamVar[1];
        pelvisNormal.value = rec.pelvis[0];
        pelvisFatigue.value = rec.pelvis[1];
        thoraxNormal.value = rec.thorax[0];
        thoraxFatigue.value = rec.thorax[1];
        updateCharts();
      }
    }

    function arrowSymbol(val, inverse=false) {
      if (val > 0) return inverse ? "🔴↓" : "🟢↑";
      if (val < 0) return inverse ? "🟢↑" : "🔴↓";
      return "⚪️→";
    }

    function diffBarHTML(val, inverse=false) {
      const absVal = Math.min(Math.abs(val),10);
      const width = absVal * 10;
      if (val > 0) return `<div class="diff-bar ${inverse?"down-bar":"up-bar"}" style="width:${width}%;"></div>`;
      if (val < 0) return `<div class="diff-bar ${inverse?"up-bar":"down-bar"}" style="width:${width}%;"></div>`;
      return `<div class="diff-bar same-bar" style="width:10%;"></div>`;
    }

    function createChart(ctx, label, data, unit, tooltipExtra=null, maxY=null) {
      return new Chart(ctx, {
        type: 'bar',
        data: { labels:['通常','疲労下'], datasets:[{label:label,data:data,backgroundColor:['#3498db','#9b59b6']}] },
        options: { responsive:true,
          plugins:{ legend:{display:false}, title:{display:true,text:label},
            tooltip:{ callbacks:{ afterBody:function(c){ if(tooltipExtra){return tooltipExtra[c[0].dataIndex];}}}}},
          scales:{ y:{ beginAtZero:true, max:maxY, title:{display:true,text:unit}}}
        }
      });
    }

    function updateCharts() {
      const baseDate = document.getElementById("dateSelect").value;
      const compareDate = document.getElementById("compareSelect").value;
      const baseRec = getRecord(currentPlayer, baseDate);
      const compareRec = compareDate ? getRecord(currentPlayer, compareDate) : null;
      if (!baseRec) return;

      const cmjVals=[parseFloat(baseRec.cmj[0])||0, parseFloat(baseRec.cmj[1])||0];
      const rjVals=[parseFloat(baseRec.rj[0])||0, parseFloat(baseRec.rj[1])||0];
      const slamVals=[parseFloat(baseRec.slam[0])||0, parseFloat(baseRec.slam[1])||0];
      const slamVar=[parseFloat(baseRec.slamVar[0])||0, parseFloat(baseRec.slamVar[1])||0];
      const opTotal=[(parseFloat(baseRec.pelvis[0])||0)+(parseFloat(baseRec.thorax[0])||0),
                     (parseFloat(baseRec.pelvis[1])||0)+(parseFloat(baseRec.thorax[1])||0)];

      if(cmjChart) cmjChart.destroy();
      if(rjChart) rjChart.destroy();
      if(slamChart) slamChart.destroy();
      if(opChart) opChart.destroy();

      cmjChart=createChart(document.getElementById('cmjChart'),'CMJ (cm)',cmjVals,'cm');
      rjChart=createChart(document.getElementById('rjChart'),'リバウンドジャンプ RSI',rjVals,'RSI');
      slamChart=createChart(document.getElementById('slamChart'),'MBスラム 平均速度 (m/s)',slamVals,'m/s',[`変動率:${slamVar[0]}%`,`変動率:${slamVar[1]}%`]);
      opChart=createChart(document.getElementById('opChart'),'操作力（10点満点）',opTotal,'得点',[`骨盤:${baseRec.pelvis[0]} 胸郭:${baseRec.thorax[0]}`,`骨盤:${baseRec.pelvis[1]} 胸郭:${baseRec.thorax[1]}`],10);

      // 総評
      const cmjRate=(cmjVals[1]/(cmjVals[0]||1))*100;
      const slamRate=(slamVals[1]/(slamVals[0]||1))*100;
      const rate=Math.min(cmjRate,slamRate);
      const output=(cmjVals[0]>=60&&rjVals[0]>=2.5&&slamVals[0]>=4.0&&slamVar[0]<=10)?"緑":(cmjVals[0]>=50&&rjVals[0]>=2.0&&slamVals[0]>=3.0&&slamVar[0]<=20)?"黄":"赤";
      const operation=(opTotal[0]>=9)?"緑":(opTotal[0]>=6)?"黄":"赤";
      const repeat=(rate>=80&&slamVar[1]<=20)?"緑":(rate>=60&&slamVar[1]<=30)?"黄":"赤";

      document.getElementById("summaryBox").innerHTML=`
        <div class="eval-box eval-${output}">出力量: ${output}</div>
        <div class="eval-box eval-${operation}">操作力: ${operation}</div>
        <div class="eval-box eval-${repeat}">再現性: ${repeat}</div>
      `;
      let actions="";
      actions += "<b>出力量:</b> "+(output==="緑"?"出力は十分。維持を優先。":output==="黄"?"出力はあるが出し切れていない。パワートレーニング強化。":"出力不足。ウエイト・ジャンプ系を重点的に。")+"<br>";
      actions += "<b>操作力:</b> "+(operation==="緑"?"骨盤と胸郭の連動良好。継続。":operation==="黄"?"連動は不安定。骨盤-胸郭連動ドリルを追加。":"体幹主導が弱い。基礎から再構築が必要。")+"<br>";
      actions += "<b>再現性:</b> "+(repeat==="緑"?"安定している。高強度下での実践へ。":repeat==="黄"?"やや乱れる。持久性トレーニングを強化。":"疲労下で大きく低下。心肺・基礎反復を優先。");

      document.getElementById("actionBox").innerHTML = actions;

      // 差分サマリー
      if (compareRec) {
        const cmjDiff = (cmjVals[0] - (parseFloat(compareRec.cmj[0])||0)).toFixed(1);
        const rjDiff = (rjVals[0] - (parseFloat(compareRec.rj[0])||0)).toFixed(2);
        const slamDiff = (slamVals[0] - (parseFloat(compareRec.slam[0])||0)).toFixed(2);
        const varDiff = (slamVar[0] - (parseFloat(compareRec.slamVar[0])||0)).toFixed(1);
        const opDiff = (opTotal[0] - ((parseFloat(compareRec.pelvis[0])||0)+(parseFloat(compareRec.thorax[0])||0))).toFixed(0);

        document.getElementById("diffBox").innerHTML = `
          <div class="diff-item">CMJ: ${cmjDiff>=0?"+":""}${cmjDiff}cm ${arrowSymbol(cmjDiff)} ${diffBarHTML(cmjDiff)}</div>
          <div class="diff-item">RSI: ${rjDiff>=0?"+":""}${rjDiff} ${arrowSymbol(rjDiff)} ${diffBarHTML(rjDiff)}</div>
          <div class="diff-item">MBスラム: ${slamDiff>=0?"+":""}${slamDiff}m/s ${arrowSymbol(slamDiff)} ${diffBarHTML(slamDiff)}</div>
          <div class="diff-item">変動率: ${varDiff>=0?"+":""}${varDiff}% ${arrowSymbol(varDiff,true)} ${diffBarHTML(-varDiff)}</div>
          <div class="diff-item">操作力: ${opDiff>=0?"+":""}${opDiff}点 ${arrowSymbol(opDiff)} ${diffBarHTML(opDiff)}</div>
        `;
      }

      // 履歴チャート更新
      drawHistoryChart(currentPlayer);
    }

    function drawHistoryChart(player) {
      let db = JSON.parse(localStorage.getItem("records") || "{}");
      const recs = (db[player] || []).sort((a,b)=> new Date(a.date) - new Date(b.date));
      if (recs.length===0){ if(historyChart) historyChart.destroy(); return; }

      const dates = recs.map(r => r.date);
      const cmj = recs.map(r => parseFloat(r.cmj[0])||0);
      const rj = recs.map(r => parseFloat(r.rj[0])||0);
      const slam = recs.map(r => parseFloat(r.slam[0])||0);
      const op   = recs.map(r => (parseFloat(r.pelvis[0])||0)+(parseFloat(r.thorax[0])||0));

      if(historyChart) historyChart.destroy();
      historyChart = new Chart(document.getElementById("historyChart"), {
        type: 'line',
        data: {
          labels: dates,
          datasets: [
            { label:"CMJ", data: cmj, borderColor:"#3498db", fill:false },
            { label:"RSI", data: rj, borderColor:"#2ecc71", fill:false },
            { label:"MBスラム", data: slam, borderColor:"#e67e22", fill:false },
            { label:"操作力", data: op, borderColor:"#9b59b6", fill:false }
          ]
        },
        options: { responsive:true, plugins:{ title:{ display:true, text:"履歴推移" } } }
      });
    }
  </script>
</body>
</html>
